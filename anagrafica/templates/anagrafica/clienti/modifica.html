{% extends "base.html" %}
{% load static %}

{% block title %}{{ page_title }} - Management System{% endblock %}

{% block content %}
<div class="container-fluid py-2 py-md-4">
    <!-- Header -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h6 class="m-0 font-weight-bold text-warning">
                        <i class="fas fa-user-edit me-2"></i>{{ page_title }}
                    </h6>
                </div>
                <div class="col-md-6 text-md-end mt-2 mt-md-0">
                    <a href="{{ object.get_absolute_url }}" class="btn btn-outline-info me-2">
                        <i class="fas fa-eye me-1"></i>Vedi Dettaglio
                    </a>
                    <a href="{% url 'anagrafica:elenco_clienti' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Torna all'Elenco
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Stato credito attuale -->
        {% if stato_credito_attuale %}
        <div class="card-footer bg-light">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        <strong>Stato Credito Attuale:</strong> 
                        <span class="{{ stato_credito_attuale.classe_css }}">{{ stato_credito_attuale.messaggio }}</span>
                    </small>
                </div>
                <div class="col-md-4 text-md-end">
                    {% if object.limite_credito > 0 %}
                        <small class="text-muted">
                            Disponibile: <strong>€{{ object.credito_disponibile|floatformat:0 }}</strong> 
                            di €{{ object.limite_credito|floatformat:0 }}
                        </small>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Form modifica cliente (stessa struttura del nuovo) -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="card-body">
                        <div class="row">
                            <!-- Dati Anagrafici -->
                            <div class="col-md-6">
                                <div class="card border-left-warning h-100">
                                    <div class="card-header bg-light">
                                        <h6 class="m-0 text-warning">
                                            <i class="fas fa-user me-1"></i>Dati Anagrafici
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label">{{ form.nome.label }}</label>
                                            {{ form.nome }}
                                            {% if form.nome.errors %}
                                                <div class="text-danger small">{{ form.nome.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">{{ form.indirizzo.label }}</label>
                                            {{ form.indirizzo }}
                                            {% if form.indirizzo.errors %}
                                                <div class="text-danger small">{{ form.indirizzo.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-8">
                                                <div class="mb-3">
                                                    <label class="form-label">{{ form.citta.label }}</label>
                                                    {{ form.citta }}
                                                    {% if form.citta.errors %}
                                                        <div class="text-danger small">{{ form.citta.errors.0 }}</div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label class="form-label">{{ form.cap.label }}</label>
                                                    {{ form.cap }}
                                                    {% if form.cap.errors %}
                                                        <div class="text-danger small">{{ form.cap.errors.0 }}</div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">{{ form.zona.label }}</label>
                                            {{ form.zona }}
                                            {% if form.zona.errors %}
                                                <div class="text-danger small">{{ form.zona.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Contatti -->
                            <div class="col-md-6">
                                <div class="card border-left-info h-100">
                                    <div class="card-header bg-light">
                                        <h6 class="m-0 text-info">
                                            <i class="fas fa-address-book me-1"></i>Contatti
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label">{{ form.telefono.label }}</label>
                                            {{ form.telefono }}
                                            {% if form.telefono.errors %}
                                                <div class="text-danger small">{{ form.telefono.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">{{ form.email.label }}</label>
                                            {{ form.email }}
                                            {% if form.email.errors %}
                                                <div class="text-danger small">{{ form.email.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">{{ form.pec.label }}</label>
                                            {{ form.pec }}
                                            {% if form.pec.errors %}
                                                <div class="text-danger small">{{ form.pec.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-4">
                            <!-- Dati Fiscali -->
                            <div class="col-md-6">
                                <div class="card border-left-secondary h-100">
                                    <div class="card-header bg-light">
                                        <h6 class="m-0 text-secondary">
                                            <i class="fas fa-file-invoice me-1"></i>Dati Fiscali
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label">{{ form.partita_iva.label }}</label>
                                            {{ form.partita_iva }}
                                            {% if form.partita_iva.errors %}
                                                <div class="text-danger small">{{ form.partita_iva.errors.0 }}</div>
                                            {% endif %}
                                            <small class="form-text text-muted">{{ form.partita_iva.help_text }}</small>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">{{ form.codice_fiscale.label }}</label>
                                            {{ form.codice_fiscale }}
                                            {% if form.codice_fiscale.errors %}
                                                <div class="text-danger small">{{ form.codice_fiscale.errors.0 }}</div>
                                            {% endif %}
                                            <small class="form-text text-muted">{{ form.codice_fiscale.help_text }}</small>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">{{ form.codice_univoco.label }}</label>
                                            {{ form.codice_univoco }}
                                            {% if form.codice_univoco.errors %}
                                                <div class="text-danger small">{{ form.codice_univoco.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Dati Commerciali -->
                            <div class="col-md-6">
                                <div class="card border-left-success h-100">
                                    <div class="card-header bg-light">
                                        <h6 class="m-0 text-success">
                                            <i class="fas fa-handshake me-1"></i>Dati Commerciali
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label">{{ form.tipo_pagamento.label }}</label>
                                            {{ form.tipo_pagamento }}
                                            {% if form.tipo_pagamento.errors %}
                                                <div class="text-danger small">{{ form.tipo_pagamento.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">{{ form.limite_credito.label }}</label>
                                            <div class="input-group">
                                                <span class="input-group-text">€</span>
                                                {{ form.limite_credito }}
                                            </div>
                                            {% if form.limite_credito.errors %}
                                                <div class="text-danger small">{{ form.limite_credito.errors.0 }}</div>
                                            {% endif %}
                                            <small class="form-text text-muted">{{ form.limite_credito.help_text }}</small>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">{{ form.giorno_chiusura.label }}</label>
                                                    {{ form.giorno_chiusura }}
                                                    {% if form.giorno_chiusura.errors %}
                                                        <div class="text-danger small">{{ form.giorno_chiusura.errors.0 }}</div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-4">
                            <!-- Orari e Note -->
                            <div class="col-12">
                                <div class="card border-left-primary">
                                    <div class="card-header bg-light">
                                        <h6 class="m-0 text-primary">
                                            <i class="fas fa-clock me-1"></i>Orari e Note
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">{{ form.orario_consegna.label }}</label>
                                                    {{ form.orario_consegna }}
                                                    {% if form.orario_consegna.errors %}
                                                        <div class="text-danger small">{{ form.orario_consegna.errors.0 }}</div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <div class="form-check">
                                                        {{ form.attivo }}
                                                        <label class="form-check-label" for="{{ form.attivo.id_for_label }}">
                                                            {{ form.attivo.label }}
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">{{ form.note.label }}</label>
                                            {{ form.note }}
                                            {% if form.note.errors %}
                                                <div class="text-danger small">{{ form.note.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Errori del form -->
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger mt-3" role="alert">
                                <h6><i class="fas fa-exclamation-triangle me-1"></i>Errori di Validazione</h6>
                                {% for error in form.non_field_errors %}
                                    <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Footer con pulsanti -->
                    <div class="card-footer bg-light">
                        <div class="row">
                            <div class="col-md-6">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Cliente creato il {{ object.created_at|date:"d/m/Y H:i" }}
                                </small>
                            </div>
                            <div class="col-md-6 text-md-end mt-2 mt-md-0">
                                <a href="{{ object.get_absolute_url }}" class="btn btn-outline-secondary me-2">
                                    <i class="fas fa-times me-1"></i>Annulla
                                </a>
                                <button type="submit" class="btn btn-warning">
                                    <i class="fas fa-save me-1"></i>Salva Modifiche
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Form styling migliorato per modifica */
.form-control:focus, .form-select:focus {
    border-color: #f39c12;
    box-shadow: 0 0 0 0.2rem rgba(243, 156, 18, 0.25);
}

/* Card con bordi colorati */
.border-left-warning { border-left: 4px solid #f39c12 !important; }
.border-left-info { border-left: 4px solid #17a2b8 !important; }
.border-left-secondary { border-left: 4px solid #6c757d !important; }
.border-left-success { border-left: 4px solid #28a745 !important; }
.border-left-primary { border-left: 4px solid #667eea !important; }

/* Evidenziazione campi modificati */
.form-control:not([readonly]):focus {
    background-color: #fff9e6;
}

/* Alert per stato credito */
.alert-credito {
    border-left: 4px solid;
    background-color: #f8f9fc;
}

.alert-credito.critico { border-color: #dc3545; }
.alert-credito.attenzione { border-color: #ffc107; }
.alert-credito.ok { border-color: #28a745; }
</style>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Evidenzia campi modificati
    $('.form-control, .form-select').on('change', function() {
        $(this).addClass('border-warning');
    });
    
    // Calcolo credito in tempo reale
    const limiteOriginale = parseFloat('{{ object.limite_credito }}') || 0;
    $('#id_limite_credito').on('input', function() {
        const nuovoLimite = parseFloat(this.value) || 0;
        const creditoUtilizzato = parseFloat('{{ object.credito_utilizzato }}') || 0;
        const nuovoDisponibile = Math.max(0, nuovoLimite - creditoUtilizzato);
        
        // Mostra preview del cambiamento
        if (nuovoLimite !== limiteOriginale) {
            if (!$('#credito-preview').length) {
                $(this).closest('.mb-3').append(`
                    <div id="credito-preview" class="alert alert-info mt-2">
                        <small>
                            <strong>Anteprima:</strong> 
                            Credito disponibile diventerà €${nuovoDisponibile.toFixed(0)}
                        </small>
                    </div>
                `);
            } else {
                $('#credito-preview small').html(`
                    <strong>Anteprima:</strong> 
                    Credito disponibile diventerà €${nuovoDisponibile.toFixed(0)}
                `);
            }
        } else {
            $('#credito-preview').remove();
        }
    });
    
    // Conferma prima di salvare se ci sono modifiche importanti
    $('form').on('submit', function(e) {
        const nuovoLimite = parseFloat($('#id_limite_credito').val()) || 0;
        
        if (nuovoLimite < limiteOriginale && nuovoLimite < {{ object.credito_utilizzato }}) {
            e.preventDefault();
            
            if (confirm('⚠️ ATTENZIONE: Il nuovo limite credito è inferiore al credito già utilizzato. Vuoi continuare?')) {
                this.submit();
            }
        }
    });
    
    // Auto-formattazione campi
    $('#id_cap').on('input', function() {
        this.value = this.value.replace(/\D/g, '').substring(0, 5);
    });
    
    $('#id_partita_iva').on('input', function() {
        let value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
        if (value.length >= 2 && !value.startsWith('IT')) {
            value = 'IT' + value.replace('IT', '');
        }
        this.value = value.substring(0, 13);
    });
    
    $('#id_codice_fiscale').on('input', function() {
        this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '').substring(0, 16);
    });
});
</script>
{% endblock %}