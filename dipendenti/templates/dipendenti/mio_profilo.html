{% extends 'base.html' %}

{% block title %}Il Mio Profilo - Management System{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="dashboard-header text-center mb-4">
        <div class="container">
            <h1 class="dashboard-title">
                <i class="fas fa-user-edit me-2"></i>
                Il Mio Profilo
            </h1>
            <p class="dashboard-subtitle mb-0">
                Gestisci le tue informazioni personali
            </p>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Profile Overview Card -->
            <div class="card card-primary mb-4">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-id-card me-2"></i>
                            Informazioni Principali
                        </div>
                        <div class="badge bg-{{ dipendente.get_stato_display|lower }}">
                            {{ dipendente.get_stato_display }}
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Profile Photo -->
                        <div class="col-md-3 text-center">
                            <div class="profile-photo-container">
                                {% if dipendente.foto_profilo %}
                                    <img src="{{ dipendente.foto_profilo.url }}" 
                                         alt="Foto Profilo" 
                                         class="rounded-circle border border-primary shadow"
                                         style="width: 150px; height: 150px; object-fit: cover;">
                                {% else %}
                                    <div class="user-avatar bg-primary d-inline-flex align-items-center justify-content-center text-white fw-bold shadow"
                                         style="width: 150px; height: 150px; font-size: 3rem;">
                                        {{ dipendente.first_name|first|upper }}{{ dipendente.last_name|first|upper }}
                                    </div>
                                {% endif %}
                                <div class="mt-3">
                                    <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#photoModal">
                                        <i class="fas fa-camera me-1"></i>
                                        Cambia Foto
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Basic Info -->
                        <div class="col-md-9">
                            <div class="row">
                                <div class="col-md-6">
                                    <h3 class="mb-1">{{ dipendente.nome_completo }}</h3>
                                    <p class="text-muted mb-3">{{ dipendente.get_livello_display }}</p>
                                    
                                    <div class="info-section">
                                        <div class="row mb-2">
                                            <div class="col-sm-5"><strong>Username:</strong></div>
                                            <div class="col-sm-7">{{ dipendente.username }}</div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-sm-5"><strong>Email:</strong></div>
                                            <div class="col-sm-7">{{ dipendente.email|default:"Non specificata" }}</div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-sm-5"><strong>Telefono:</strong></div>
                                            <div class="col-sm-7">{{ dipendente.telefono|default:"Non specificato" }}</div>
                                        </div>
                                        {% if dipendente.data_nascita %}
                                        <div class="row mb-2">
                                            <div class="col-sm-5"><strong>Data di nascita:</strong></div>
                                            <div class="col-sm-7">{{ dipendente.data_nascita|date:"d/m/Y" }} ({{ dipendente.eta }} anni)</div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="info-section">
                                        {% if dipendente.data_assunzione %}
                                        <div class="row mb-2">
                                            <div class="col-sm-5"><strong>Data assunzione:</strong></div>
                                            <div class="col-sm-7">{{ dipendente.data_assunzione|date:"d/m/Y" }}</div>
                                        </div>
                                        {% endif %}
                                        {% if dipendente.anni_servizio %}
                                        <div class="row mb-2">
                                            <div class="col-sm-5"><strong>Anni di servizio:</strong></div>
                                            <div class="col-sm-7">{{ dipendente.anni_servizio }} anni</div>
                                        </div>
                                        {% endif %}
                                        <div class="row mb-2">
                                            <div class="col-sm-5"><strong>Ultimo accesso:</strong></div>
                                            <div class="col-sm-7">
                                                {% if dipendente.ultimo_accesso %}
                                                    {{ dipendente.ultimo_accesso|date:"d/m/Y H:i" }}
                                                {% else %}
                                                    Primo accesso
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-sm-5"><strong>Account creato:</strong></div>
                                            <div class="col-sm-7">{{ dipendente.date_joined|date:"d/m/Y" }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex gap-2 mt-3">
                                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                                    <i class="fas fa-edit me-2"></i>
                                    Modifica Informazioni
                                </button>
                                <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                                    <i class="fas fa-key me-2"></i>
                                    Cambia Password
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Documents Section -->
            <div class="row">
                <!-- Identity Documents -->
                <div class="col-lg-6 mb-4">
                    <div class="card card-success h-100">
                        <div class="card-header">
                            <i class="fas fa-id-card me-2"></i>
                            Documenti di Identità
                        </div>
                        <div class="card-body">
                            <!-- Codice Fiscale -->
                            <div class="document-item mb-3 p-3 border rounded">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">
                                            <i class="fas fa-credit-card me-2 text-primary"></i>
                                            Codice Fiscale
                                        </h6>
                                        <p class="mb-0">
                                            {% if dipendente.codice_fiscale %}
                                                <code>{{ dipendente.codice_fiscale }}</code>
                                            {% else %}
                                                <span class="text-muted">Non specificato</span>
                                            {% endif %}
                                        </p>
                                    </div>
                                    {% if dipendente.documento_codice_fiscale %}
                                        <a href="{{ dipendente.documento_codice_fiscale.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Carta di Identità -->
                            <div class="document-item mb-3 p-3 border rounded">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">
                                            <i class="fas fa-id-badge me-2 text-success"></i>
                                            Carta di Identità
                                        </h6>
                                        <p class="mb-0">
                                            {% if dipendente.carta_identita_numero %}
                                                N. {{ dipendente.carta_identita_numero }}
                                            {% else %}
                                                <span class="text-muted">Non specificata</span>
                                            {% endif %}
                                        </p>
                                        {% if dipendente.carta_identita_scadenza %}
                                            <small class="text-muted">
                                                Scadenza: {{ dipendente.carta_identita_scadenza|date:"d/m/Y" }}
                                                {% if dipendente.carta_identita_scadenza < today %}
                                                    <span class="badge bg-danger">Scaduta</span>
                                                {% elif dipendente.carta_identita_scadenza < next_month %}
                                                    <span class="badge bg-warning">In scadenza</span>
                                                {% endif %}
                                            </small>
                                        {% endif %}
                                    </div>
                                    {% if dipendente.documento_carta_identita %}
                                        <a href="{{ dipendente.documento_carta_identita.url }}" target="_blank" class="btn btn-sm btn-outline-success">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Patente -->
                            <div class="document-item mb-3 p-3 border rounded">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">
                                            <i class="fas fa-car me-2 text-warning"></i>
                                            Patente di Guida
                                        </h6>
                                        <p class="mb-0">
                                            {% if dipendente.patente_numero %}
                                                N. {{ dipendente.patente_numero }}
                                                {% if dipendente.patente_categorie %}
                                                    ({{ dipendente.patente_categorie }})
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">Non specificata</span>
                                            {% endif %}
                                        </p>
                                        {% if dipendente.patente_scadenza %}
                                            <small class="text-muted">
                                                Scadenza: {{ dipendente.patente_scadenza|date:"d/m/Y" }}
                                                {% if dipendente.patente_scadenza < today %}
                                                    <span class="badge bg-danger">Scaduta</span>
                                                {% elif dipendente.patente_scadenza < next_month %}
                                                    <span class="badge bg-warning">In scadenza</span>
                                                {% endif %}
                                            </small>
                                        {% endif %}
                                    </div>
                                    {% if dipendente.documento_patente %}
                                        <a href="{{ dipendente.documento_patente.url }}" target="_blank" class="btn btn-sm btn-outline-warning">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="text-center">
                                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#documentsModal">
                                    <i class="fas fa-upload me-2"></i>
                                    Carica/Aggiorna Documenti
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Additional Info -->
                <div class="col-lg-6 mb-4">
                    <div class="card card-info h-100">
                        <div class="card-header">
                            <i class="fas fa-info-circle me-2"></i>
                            Informazioni Aggiuntive
                        </div>
                        <div class="card-body">
                            <div class="info-section">
                                <h6><i class="fas fa-home me-2"></i>Contatti</h6>
                                <div class="mb-3">
                                    <div class="row mb-2">
                                        <div class="col-sm-5"><strong>Indirizzo:</strong></div>
                                        <div class="col-sm-7">{{ dipendente.indirizzo|default:"Non specificato" }}</div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-sm-5"><strong>Telefono principale:</strong></div>
                                        <div class="col-sm-7">{{ dipendente.telefono|default:"Non specificato" }}</div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-sm-5"><strong>Telefono emergenza:</strong></div>
                                        <div class="col-sm-7">{{ dipendente.telefono_emergenza|default:"Non specificato" }}</div>
                                    </div>
                                </div>

                                {% if dipendente.posizione_inail or dipendente.posizione_inps %}
                                <h6><i class="fas fa-building me-2"></i>Posizioni Assicurative</h6>
                                <div class="mb-3">
                                    {% if dipendente.posizione_inail %}
                                    <div class="row mb-2">
                                        <div class="col-sm-5"><strong>Posizione INAIL:</strong></div>
                                        <div class="col-sm-7">{{ dipendente.posizione_inail }}</div>
                                    </div>
                                    {% endif %}
                                    {% if dipendente.posizione_inps %}
                                    <div class="row mb-2">
                                        <div class="col-sm-5"><strong>Posizione INPS:</strong></div>
                                        <div class="col-sm-7">{{ dipendente.posizione_inps }}</div>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endif %}

                                <!-- Quick Actions -->
                                <h6><i class="fas fa-tools me-2"></i>Azioni Rapide</h6>
                                <div class="d-grid gap-2">
                                    <a href="{% url 'dipendenti:dashboard' %}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-tachometer-alt me-2"></i>
                                        Torna alla Dashboard
                                    </a>
                                    <button type="button" class="btn btn-sm btn-outline-info" onclick="window.print()">
                                        <i class="fas fa-print me-2"></i>
                                        Stampa Profilo
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Documents Expiry Alert -->
            {% if dipendente.documenti_in_scadenza %}
            <div class="row">
                <div class="col-12">
                    <div class="alert alert-warning">
                        <h5 class="alert-heading">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Documenti in Scadenza
                        </h5>
                        <p>Hai dei documenti che scadranno a breve. Ti consigliamo di rinnovarli quanto prima:</p>
                        <ul class="mb-0">
                            {% for doc in dipendente.documenti_in_scadenza %}
                                <li>
                                    <strong>{{ doc.tipo }}</strong>: 
                                    {% if doc.scaduto %}
                                        <span class="text-danger">Scaduto il {{ doc.scadenza|date:"d/m/Y" }}</span>
                                    {% else %}
                                        <span class="text-warning">Scade il {{ doc.scadenza|date:"d/m/Y" }}</span>
                                    {% endif %}
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modals -->
<!-- Edit Profile Modal -->
<div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editProfileModalLabel">
                    <i class="fas fa-edit me-2"></i>
                    Modifica Profilo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><i class="fas fa-info-circle me-2"></i>Questa funzionalità sarà implementata a breve.</p>
                <p>Per ora, contatta l'amministratore per modifiche ai dati personali.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
            </div>
        </div>
    </div>
</div>

<!-- Change Password Modal -->
<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="changePasswordModalLabel">
                    <i class="fas fa-key me-2"></i>
                    Cambia Password
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><i class="fas fa-info-circle me-2"></i>Questa funzionalità sarà implementata a breve.</p>
                <p>Per ora, contatta l'amministratore per il cambio password.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
            </div>
        </div>
    </div>
</div>

<!-- Photo Modal -->
<div class="modal fade" id="photoModal" tabindex="-1" aria-labelledby="photoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="photoModalLabel">
                    <i class="fas fa-camera me-2"></i>
                    Cambia Foto Profilo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><i class="fas fa-info-circle me-2"></i>Questa funzionalità sarà implementata a breve.</p>
                <p>Per ora, contatta l'amministratore per aggiornare la foto profilo.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
            </div>
        </div>
    </div>
</div>

<!-- Documents Modal -->
<div class="modal fade" id="documentsModal" tabindex="-1" aria-labelledby="documentsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="documentsModalLabel">
                    <i class="fas fa-upload me-2"></i>
                    Gestione Documenti
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><i class="fas fa-info-circle me-2"></i>Questa funzionalità sarà implementata a breve.</p>
                <p>Per ora, contatta l'amministratore per caricare o aggiornare i documenti.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Profile page enhancements
    document.addEventListener('DOMContentLoaded', function() {
        // Add dates for comparison
        window.today = new Date();
        window.next_month = new Date();
        window.next_month.setMonth(window.next_month.getMonth() + 1);
        
        // Animate document cards
        const documentItems = document.querySelectorAll('.document-item');
        documentItems.forEach((item, index) => {
            item.style.opacity = '0';
            item.style.transform = 'translateX(-20px)';
            
            setTimeout(() => {
                item.style.transition = 'all 0.6s ease';
                item.style.opacity = '1';
                item.style.transform = 'translateX(0)';
            }, index * 100);
        });
        
        // Add print styles
        const style = document.createElement('style');
        style.textContent = `
            @media print {
                .btn, .modal, .navbar, .sidebar {
                    display: none !important;
                }
                .card {
                    border: 1px solid #ddd !important;
                    box-shadow: none !important;
                }
                .main-content {
                    margin-left: 0 !important;
                }
            }
        `;
        document.head.appendChild(style);
    });
</script>
{% endblock %}